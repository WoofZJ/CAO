@inject AdminService adminService;

@if (loading)
{
    <Loading Message="正在加载文章元数据..." />
}
else if (notFound)
{
    <Alert Type="error" Message=@error />
}
else
{
    <fieldset class="fieldset bg-base-200 border-base-300 rounded-box border p-4">
        <legend class="fieldset-legend">元数据 & 操作</legend>

        <div class="flex flex-col md:flex-row flex-wrap gap-x-2">
            <div class="md:flex-1/3">
                <label class="label">标题</label>
                <input type="text" class="input w-full" @bind="Title" />
            </div>
            <div class="md:flex-1/3">
                <label class="label">链接名</label>
                <input type="text" class="input w-full" @bind="Slug" />
            </div>
        </div>

        <label class="label">首图 Url</label>
        <input type="text" class="input w-full" @bind="ImageUrl" />

        <label class="label">标签</label>
        <input type="text" class="input w-full" @bind="Tags" />

        <label class="label">简介</label>
        <textarea class="textarea w-full" rows="4" @bind="Description"></textarea>
        <div class="flex flex-row gap-4 mt-2 flex-wrap">
            <label class="label">
                <input type="checkbox" class="checkbox checkbox-sm" @bind="IsRecommended" />
                推荐
            </label>
            <label class="label">
                <input type="checkbox" class="checkbox checkbox-sm" @bind="IsSticky" />
                置顶
            </label>
            <label class="label">
                <input type="radio" name="status-radio" class="radio radio-sm" checked="@(Status == 0)" @onchange="@(() => Status = 0)" />
                草稿
            </label>
            <label class="label">
                <input type="radio" name="status-radio" class="radio radio-sm" checked="@(Status == 1)" @onchange="@(() => Status = 1)" />
                发布
            </label>
            <label class="label">
                <input type="radio" name="status-radio" class="radio radio-sm" checked="@(Status == 2)" @onchange="@(() => Status = 2)"/>
                归档
            </label>
            <button class="btn ml-auto" @onclick="SaveMetadataAsync" disabled="@(submitStatus == SubmitStatus.Submitting)">
                保存
            </button>
        </div>
        <div>
            @switch (submitStatus)
            {
                case SubmitStatus.Submitting:
                    <Loading Message="保存中..." />
                    break;
                case SubmitStatus.Failed:
                    <Alert Type="error" Message=@error />
                    break;
                case SubmitStatus.Success:
                    <Alert Type="success" Message="保存成功！" />
                    break;
            }
        </div>
    </fieldset>
}

@code {
    [Parameter]
    public int Id { get; set; }

    [Parameter]
    public EventCallback<int> IdChanged { get; set; }

    public string Title { get; set; } = string.Empty;
    public string Slug { get; set; } = string.Empty;
    public string Description { get; set; } = string.Empty;
    public string ImageUrl { get; set; } = string.Empty;
    public string Tags { get; set; } = string.Empty;
    public int Status { get; set; }
    public bool IsRecommended { get; set; }
    public bool IsSticky { get; set; }
    private bool loading { get; set; } = false;
    private bool notFound { get; set; } = false;

    enum SubmitStatus
    {
        None,
        Submitting,
        Success,
        Failed
    }
    private SubmitStatus submitStatus = SubmitStatus.None;
    string error = "";

    protected override async Task OnInitializedAsync()
    {
        if (Id != 0)
        {
            loading = true;
            await FetchMetadataAsync(Id);
            loading = false;
        }
    }

    private async Task FetchMetadataAsync(int id)
    {
        var metadata = await adminService.GetBlogEditMetadataAsync(id);
        if (metadata is not null)
        {
            Title = metadata.Title;
            Slug = metadata.Slug;
            Description = metadata.Description;
            ImageUrl = metadata.ImageUrl;
            Tags = string.Join(",", metadata.Tags);
            Status = metadata.Status;
            IsRecommended = metadata.IsRecommended;
            IsSticky = metadata.IsSticky;
        }
        else
        {
            notFound = true;
            error = "无法获取文章元数据，文章不存在";
        }
    }

    private async Task SaveMetadataAsync()
    {
        submitStatus = SubmitStatus.Submitting;
        StateHasChanged();
        var metadata = new BlogEditMetadataDto(
            Id,
            Title,
            Slug,
            Description,
            ImageUrl,
            Tags.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries).ToList(),
            Status,
            IsRecommended,
            IsSticky
        );
        BlogEditMetadataResponseDto? response = await adminService.UpdateBlogEditMetadataAsync(metadata);
        if (response is null)
        {
            submitStatus = SubmitStatus.Failed;
            error = "服务器暂不可用，过会再试试吧 ;-;";
        }
        else if(!response.Success)
        {
            submitStatus = SubmitStatus.Failed;
            error = response.SlugExists ? "保存失败，链接名已存在" : "保存失败，发生未知错误";
        }
        else
        {
            submitStatus = SubmitStatus.Success;
            if (Id == 0)
            {
                Id = response.Id;
                await IdChanged.InvokeAsync(Id);
            }
        }
    }
}